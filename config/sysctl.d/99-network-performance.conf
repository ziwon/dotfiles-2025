# Core Network Buffers - Optimized for 500-1000 Mbps
net.core.rmem_max = 134217728          # Reduced from 536MB (excessive for 500 Mbps)
net.core.wmem_max = 134217728          # 128MB is plenty
net.core.rmem_default = 33554432       # 32MB default (was 67MB)
net.core.wmem_default = 33554432       # 32MB default
net.core.optmem_max = 65536            # Reduced from 134MB (excessive)
net.core.netdev_max_backlog = 10000    # Reduced from 50000 (better latency)
net.core.netdev_budget = 600           # Reduced from 1000
net.core.netdev_budget_usecs = 2000    # OK

# TCP Buffer Tuning
net.ipv4.tcp_rmem = 4096 131072 134217728  # Adjusted max to match core
net.ipv4.tcp_wmem = 4096 65536 134217728   # Adjusted max to match core

# BBR Congestion Control 
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq

# TCP Features
net.ipv4.tcp_fastopen = 3              # OK - speeds up connections
net.ipv4.tcp_mtu_probing = 1           # OK - finds optimal MTU
net.ipv4.tcp_timestamps = 1            # OK - required for BBR
net.ipv4.tcp_sack = 1                  # OK - selective ACK
net.ipv4.tcp_window_scaling = 1        # OK - required for large windows
net.ipv4.tcp_slow_start_after_idle = 0 # OK - better for streaming
net.ipv4.tcp_no_metrics_save = 1       # OK - don't cache metrics
net.ipv4.tcp_moderate_rcvbuf = 1       # OK - auto-tune buffers

# Low Latency Optimizations
net.ipv4.tcp_low_latency = 1           # OK - prefer latency
net.ipv4.tcp_adv_win_scale = 2         # OK

# Connection Management
net.ipv4.ip_local_port_range = 2048 65535  # Started at 2048 (avoid well-known)
net.ipv4.tcp_tw_reuse = 1              # OK - reuse TIME_WAIT
net.ipv4.tcp_fin_timeout = 15          # OK - faster cleanup
net.ipv4.tcp_keepalive_time = 300      # OK - 5 minutes
net.ipv4.tcp_keepalive_probes = 5      # OK
net.ipv4.tcp_keepalive_intvl = 15      # OK

# Packet Steering (single queue NIC optimization)
net.core.rps_sock_flow_entries = 32768 # Single value

# BBR-specific optimizations
net.ipv4.tcp_ecn = 0                   # Disabled - doesn't work well with BBR v1
net.ipv4.tcp_reordering = 5            # OK - handles packet reordering
net.ipv4.tcp_recovery = 1              # OK - better recovery